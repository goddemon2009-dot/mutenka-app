<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.4/dist/tesseract.min.js"></script>
    <style type="text/tailwindcss">
        .active-tab { border-bottom: 4px solid #10b981; @apply text-emerald-600; }
        .menu-btn { @apply flex flex-col items-center p-6 rounded-3xl shadow-md transition-all active:scale-95; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
    <header class="bg-emerald-600 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-xl font-bold">ã“ã ã‚ã‚Šã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯</h1>
        <div id="auth-ui">
            <button id="login-btn" onclick="login()" class="text-xs bg-white/20 px-3 py-1 rounded-lg border border-white/50">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button id="logout-btn" onclick="logout()" class="hidden text-xs bg-red-500/80 px-3 py-1 rounded-lg">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto">
        <div id="section-home" class="grid grid-cols-1 gap-6 pt-10 text-center">
            <button onclick="startCamera()" class="menu-btn bg-blue-600 text-white"><span class="text-4xl mb-2">ğŸ“¸</span><span class="font-bold text-lg">ã‚«ãƒ¡ãƒ©ã§ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ›</span></button>
            <button onclick="view('section-form')" class="menu-btn bg-white text-emerald-700 border-2 border-emerald-100"><span class="text-4xl mb-2">ğŸ“</span><span class="font-bold text-lg">è©³ç´°å…¥åŠ›ãƒ»æ€ã„å‡ºã‚’è¨˜éŒ²</span></button>
            <button onclick="view('section-browse'); display();" class="menu-btn bg-emerald-500 text-white"><span class="text-4xl mb-2">ğŸ‘€</span><span class="font-bold text-lg">ã¿ã‚“ãªã®è¨˜éŒ²ã‚’è¦‹ã‚‹</span></button>
        </div>

        <div id="section-camera" class="hidden">
            <div id="reader" class="shadow-2xl mb-4 bg-black rounded-3xl overflow-hidden"></div>
            <button onclick="view('section-home')" class="w-full py-3 bg-gray-400 text-white rounded-xl font-bold">Ã— æˆ»ã‚‹</button>
        </div>

        <div id="section-form" class="hidden bg-white p-6 rounded-3xl shadow-sm border space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold text-emerald-700">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                <button onclick="view('section-home'); reset();" class="text-gray-400 text-2xl">Ã—</button>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                <select id="author" class="p-2.5 border rounded-xl bg-gray-50 text-sm font-bold">
                    <option value="ã—ã‚‡ã†ã‚„">ğŸ‘¤ ã—ã‚‡ã†ã‚„</option><option value="ã˜ã‚…ã‚“ã“">ğŸ‘© ã˜ã‚…ã‚“ã“</option><option value="ãµã¿ã²ã“">ğŸ‘¨ ãµã¿ã²ã“</option>
                </select>
                <select id="category" onchange="toggle(this.value)" class="p-2.5 border-2 border-blue-100 rounded-xl bg-blue-50 text-xs font-bold text-blue-700">
                    <option value="gourmet">ğŸ´ ã‚°ãƒ«ãƒ¡</option><option value="item">ğŸ§´ èª¿å‘³æ–™ãƒ»æ—¥ç”¨å“</option><option value="hotel">ğŸ¨ ãƒ›ãƒ†ãƒ«</option><option value="sushi">ğŸ£ å¯¿å¸</option>
                </select>
            </div>

            <div class="flex gap-2">
                <input type="text" id="name" placeholder="åç§°" class="w-full p-3 border rounded-xl font-bold">
                <button id="btn-search" onclick="search('name')" class="bg-blue-500 text-white px-3 rounded-xl text-[10px] font-bold">ğŸ” æ¤œç´¢</button>
            </div>

            <div id="box-phone" class="flex gap-2">
                <input type="tel" id="phone" placeholder="é›»è©±ç•ªå·" class="w-full p-3 border rounded-xl text-sm">
                <button onclick="search('phone')" class="bg-indigo-500 text-white px-3 rounded-xl text-[10px] font-bold">ğŸ“ æ¤œç´¢</button>
            </div>

            <div id="box-sushi" class="hidden space-y-2 bg-red-50 p-3 rounded-xl"><input type="text" id="fish" placeholder="ãƒã‚¿" class="w-full p-2 text-xs border rounded-lg"><input type="text" id="vinegar" placeholder="ã‚·ãƒ£ãƒª" class="w-full p-2 text-xs border rounded-lg"></div>
            <div id="box-hotel" class="hidden space-y-2 bg-indigo-50 p-3 rounded-xl"><input type="text" id="interior" placeholder="å†…è£…" class="w-full p-2 text-xs border rounded-lg"><input type="text" id="meal" placeholder="é£Ÿäº‹" class="w-full p-2 text-xs border rounded-lg"></div>
            <div id="box-item" class="hidden space-y-3"><div id="price-list" class="space-y-3"></div><button onclick="addPrice()" class="w-full py-2 bg-orange-50 text-orange-600 border border-orange-200 rounded-xl text-xs font-bold">+ è³¼å…¥å…ˆã‚’è¿½åŠ </button></div>

            <input type="text" id="location" placeholder="å ´æ‰€ãƒ»ä½æ‰€" class="w-full p-3 border rounded-xl text-sm">
            <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100"><label class="text-[10px] font-bold text-yellow-600">æº€è¶³åº¦</label><input type="range" id="rating" min="1" max="5" value="3" class="w-full accent-yellow-500"></div>
            <input type="url" id="url" placeholder="ğŸ”— URL" class="w-full p-3 border border-blue-100 rounded-xl text-sm bg-blue-50/20">
            
            <div class="p-4 border-2 border-dashed border-emerald-100 rounded-xl bg-emerald-50/20">
                <input type="file" id="photo" accept="image/*" multiple class="text-xs w-full" onchange="ocr(this)">
                <div id="ocr-msg" class="text-[9px] text-blue-600 font-bold mt-2"></div>
            </div>

            <textarea id="memo" placeholder="ã“ã ã‚ã‚Šãƒ¡ãƒ¢" class="w-full p-3 border rounded-xl h-24 text-sm"></textarea>
            <input type="hidden" id="barcode">
            <button onclick="save()" id="save-btn" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-lg disabled:bg-gray-300">ä¿å­˜ã—ã¦åŒæœŸ</button>
        </div>

        <div id="section-browse" class="hidden">
            <div class="flex justify-between items-center mb-4 sticky top-16 bg-gray-100 py-2 z-40">
                <button onclick="view('section-home')" class="text-emerald-700 font-bold text-sm">â† æˆ»ã‚‹</button>
                <input type="text" id="q" oninput="display()" placeholder="ğŸ” æ¤œç´¢..." class="p-2 border rounded-full text-xs w-1/2 shadow-sm outline-none">
            </div>
            <nav class="flex overflow-x-auto gap-4 mb-6 border-b pb-2 sticky top-28 bg-gray-100 z-40 font-bold">
                <button onclick="tab('gourmet')" id="t-gourmet" class="active-tab">ã‚°ãƒ«ãƒ¡</button>
                <button onclick="tab('item')" id="t-item" class="text-gray-400">æ—¥ç”¨å“</button>
                <button onclick="tab('hotel')" id="t-hotel" class="text-gray-400">ãƒ›ãƒ†ãƒ«</button>
                <button onclick="tab('sushi')" id="t-sushi" class="text-gray-400">å¯¿å¸</button>
            </nav>
            <div id="list" class="space-y-6 pb-20"></div>
        </div>
    </main>

    <script>
        // 1. åˆæœŸåŒ–ã‚’æœ€é€Ÿã§è¡Œã†
        const config = { apiKey: "AIzaSyDONjnOEGSzrN3rx-Hhlcq5ew67FTPzvbI", authDomain: "mutenka-app.firebaseapp.com", databaseURL: "https://mutenka-app-default-rtdb.firebaseio.com", projectId: "mutenka-app", storageBucket: "mutenka-app.firebasestorage.app", messagingSenderId: "69649285337", appId: "1:69649285337:web:47d607b94f3331eeca3ec8" };
        firebase.initializeApp(config);
        
        // 2. ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ï¼ˆvarã‚’ä½¿ç”¨ã—ã¦åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã‚ºãƒ¬ã‚’é˜²ãï¼‰
        var auth = firebase.auth();
        var db = firebase.database();
        var storage = firebase.storage();
        var user = null, currentTab = 'gourmet', editId = null;

        // ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦–
        auth.onAuthStateChanged(u => {
            user = u;
            document.getElementById('login-btn').classList.toggle('hidden', !!u);
            document.getElementById('logout-btn').classList.toggle('hidden', !u);
            document.getElementById('save-btn').disabled = !u;
            if (u) console.log("Login Success UID:", u.uid);
            display();
        });

        async function login() {
            try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } 
            catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + e.message); }
        }
        function logout() { if(confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼Ÿ')) auth.signOut(); }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆå…±é€šé–¢æ•°
        function view(id) {
            ['section-home', 'section-camera', 'section-form', 'section-browse'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // å…¥åŠ›é …ç›®ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggle(cat) {
            document.getElementById('box-sushi').classList.toggle('hidden', cat !== 'sushi');
            document.getElementById('box-hotel').classList.toggle('hidden', cat !== 'hotel');
            document.getElementById('box-item').classList.toggle('hidden', cat !== 'item');
            const isNiche = (cat === 'sushi' || cat === 'item');
            document.getElementById('box-phone').classList.toggle('hidden', isNiche);
            document.getElementById('btn-search').classList.toggle('hidden', isNiche);
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function save() {
            if (!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
            const name = document.getElementById('name').value.trim();
            if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "åŒæœŸä¸­...";

            try {
                let imgUrls = [];
                const files = document.getElementById('photo').files;
                for (let f of files) {
                    const ref = storage.ref(`images/${Date.now()}_${f.name}`);
                    await ref.put(f);
                    imgUrls.push(await ref.getDownloadURL());
                }

                const prices = Array.from(document.querySelectorAll('#price-list > div')).map(el => ({
                    shop: el.querySelector('.p-shop').value, price: el.querySelector('.p-val').value, url: el.querySelector('.p-url').value
                }));

                const data = {
                    author: document.getElementById('author').value, name, category: document.getElementById('category').value,
                    location: document.getElementById('location').value, phone: document.getElementById('phone').value,
                    url: document.getElementById('url').value, memo: document.getElementById('memo').value,
                    rating: document.getElementById('rating').value, sushiFish: document.getElementById('fish').value,
                    sushiVinegar: document.getElementById('vinegar').value, hotelInterior: document.getElementById('interior').value,
                    hotelMeal: document.getElementById('meal').value, barcode: document.getElementById('barcode').value,
                    timestamp: Date.now(), imageUrls: imgUrls.length ? imgUrls : null, prices: prices.length ? prices : null
                };

                const ref = editId ? db.ref('items/' + editId) : db.ref('items').push();
                await ref.update(data);
                reset(); view('section-browse');
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); } finally { btn.disabled = false; btn.innerText = "ä¿å­˜ã—ã¦åŒæœŸ"; }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¸€è¦§è¡¨ç¤º
        function display() {
            db.ref('items').off();
            db.ref('items').on('value', snap => {
                const list = document.getElementById('list');
                list.innerHTML = '';
                const items = snap.val(); if (!items) return;
                const searchTxt = document.getElementById('q').value.toLowerCase();

                Object.keys(items).reverse().forEach(id => {
                    const it = items[id];
                    if (it.category !== currentTab || (searchTxt && !it.name.toLowerCase().includes(searchTxt))) return;

                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-3xl shadow-sm border p-5 font-bold';
                    div.innerHTML = `
                        ${it.imageUrls ? `<div class="image-grid mb-4">${it.imageUrls.map(u => `<img src="${u}" class="w-full h-24 object-cover rounded-xl">`).join('')}</div>` : ''}
                        <div class="flex justify-between text-[10px] mb-2"><span class="text-emerald-600">ğŸ‘¤ ${it.author}</span>
                        <div class="${user ? '' : 'hidden'} space-x-3 text-gray-400"><button onclick="edit('${id}')">ç·¨é›†</button><button onclick="del('${id}')" class="text-red-300">å‰Šé™¤</button></div></div>
                        <h3 class="text-lg mb-1">${it.name}</h3>
                        <div class="text-yellow-500 mb-2">${"â­".repeat(it.rating)}</div>
                        <p class="text-xs text-gray-500 mb-3">${it.location || ''}</p>
                        <div class="bg-emerald-50 p-3 rounded-xl text-xs text-gray-600 mb-2 whitespace-pre-wrap">${it.memo || ''}</div>
                        ${it.url ? `<a href="${it.url}" target="_blank" class="text-blue-500 text-[10px] underline">ğŸ”— ãƒªãƒ³ã‚¯</a>` : ''}
                    `;
                    list.appendChild(div);
                });
            });
        }

        function edit(id) {
            db.ref('items/' + id).once('value', snap => {
                const it = snap.val(); editId = id; view('section-form');
                document.getElementById('category').value = it.category; toggle(it.category);
                document.getElementById('name').value = it.name;
                document.getElementById('location').value = it.location;
                document.getElementById('memo').value = it.memo;
                document.getElementById('rating').value = it.rating;
            });
        }

        function del(id) { if(confirm('å‰Šé™¤ï¼Ÿ')) db.ref('items/' + id).remove(); }
        function reset() { editId = null; document.getElementById('name').value = ''; document.getElementById('memo').value = ''; document.getElementById('price-list').innerHTML = ''; }
        function addPrice() {
            const d = document.createElement('div'); d.className = 'p-3 bg-gray-50 rounded-xl space-y-2 relative';
            d.innerHTML = `<button onclick="this.parentElement.remove()" class="absolute top-1 right-2 text-gray-300">Ã—</button><input type="text" placeholder="åº—" class="p-shop w-full p-2 text-xs border rounded-lg"><div class="flex gap-2"><input type="number" placeholder="ä¾¡æ ¼" class="p-val w-24 p-2 text-xs border rounded-lg"><input type="text" placeholder="URL" class="p-url w-full p-2 text-xs border rounded-lg"></div>`;
            document.getElementById('price-list').appendChild(d);
        }
        function tab(t) { currentTab = t; document.querySelectorAll('nav button').forEach(b => b.className = 'text-gray-400'); document.getElementById('t-'+t).className = 'active-tab'; display(); }
        function search(t) { window.open(`https://www.google.com/search?q=${encodeURIComponent(document.getElementById(t).value + (t==='name'?' ä½æ‰€':''))}`, '_blank'); }
        function startCamera() { view('section-camera'); const h = new Html5Qrcode("reader"); h.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (d) => { h.stop(); document.getElementById('barcode').value = d; view('section-form'); toggle('item'); }); }
        async function ocr(i) { document.getElementById('ocr-msg').innerText = "â³ è§£æä¸­..."; const r = await Tesseract.recognize(i.files[0], 'jpn'); document.getElementById('memo').value += "\n" + r.data.text; document.getElementById('ocr-msg').innerText = "âœ… å®Œäº†"; }
    </script>
</body>
</html>
