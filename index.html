<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶æ—ã®ç„¡æ·»åŠ ãƒ©ã‚¤ãƒ•ç®¡ç† - æœ€çµ‚ç©¶æ¥µç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-storage-compat.js"></script>
    <style>
        .active-tab { border-bottom: 4px solid #10b981; color: #10b981; }
        .force-left { text-align: left !important; display: block !important; width: 100%; }
        summary { cursor: pointer; list-style: none; outline: none; }
        summary::-webkit-details-marker { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .share-mode-bg { background-color: #f0fdf4; }
    </style>
</head>
<body id="body" class="bg-gray-100 text-gray-900 font-sans transition-colors duration-300">

    <header class="bg-emerald-600 text-white p-4 shadow-lg sticky top-0 z-40">
        <h1 id="main-title" class="text-xl font-bold text-center">å®¶æ—ã®ç„¡æ·»åŠ ãƒ©ã‚¤ãƒ•ç®¡ç†</h1>
        <div class="flex justify-center mt-3">
            <div class="inline-flex bg-emerald-700/50 rounded-lg p-1">
                <button onclick="setViewMode('my')" id="mode-my" class="px-4 py-1 rounded-md text-xs font-bold bg-white text-emerald-700 shadow-sm">è‡ªåˆ†ãƒ»å®¶æ—ç”¨</button>
                <button onclick="setViewMode('share')" id="mode-share" class="px-4 py-1 rounded-md text-xs font-bold text-white/70">è·å ´å…±æœ‰ç”¨</button>
            </div>
        </div>
    </header>

    <nav id="category-nav" class="flex overflow-x-auto bg-white shadow-sm sticky top-[108px] z-30 border-b no-scrollbar">
        <button onclick="switchTab('gourmet')" id="tab-gourmet" class="p-3 whitespace-nowrap min-w-[80px] active-tab font-bold">ã‚°ãƒ«ãƒ¡</button>
        <button onclick="switchTab('shop')" id="tab-shop" class="p-3 whitespace-nowrap min-w-[80px] font-bold">ã‚¹ãƒ¼ãƒ‘ãƒ¼</button>
        <button onclick="switchTab('item')" id="tab-item" class="p-3 whitespace-nowrap min-w-[80px] font-bold">èª¿å‘³æ–™ãƒ»æ—¥ç”¨å“</button>
        <button onclick="switchTab('hotel')" id="tab-hotel" class="p-3 whitespace-nowrap min-w-[80px] font-bold">ãƒ›ãƒ†ãƒ«</button>
        <button onclick="switchTab('sushi')" id="tab-sushi" class="p-3 whitespace-nowrap min-w-[80px] font-bold">å¯¿å¸</button>
    </nav>

    <div class="p-4 sticky top-[156px] bg-inherit z-20">
        <input type="text" id="searchInput" oninput="displayData()" placeholder="ğŸ” æ¤œç´¢..." class="w-full p-3 rounded-full border shadow-sm outline-none bg-white">
    </div>

    <main class="p-4 max-w-md mx-auto">
        <div id="input-section" class="bg-white p-5 rounded-2xl shadow-sm mb-8 border border-gray-200">
            <h2 id="form-title" class="text-lg font-bold mb-4 text-emerald-700 font-bold">ğŸ“ æ–°è¦ç™»éŒ²</h2>
            <div class="space-y-4">
                <select id="author" class="w-full p-2.5 border rounded-lg bg-emerald-50 font-bold text-sm">
                    <option value="ã—ã‚‡ã†ã‚„">ğŸ‘¤ ã—ã‚‡ã†ã‚„</option>
                    <option value="ã˜ã‚…ã‚“ã“">ğŸ‘© ã˜ã‚…ã‚“ã“</option>
                    <option value="ãµã¿ã²ã“">ğŸ‘¨ ãµã¿ã²ã“</option>
                </select>

                <input type="text" id="name" placeholder="åç§°ï¼ˆåº—åãƒ»å•†å“åï¼‰" class="w-full p-2.5 border rounded-lg text-sm">

                <div id="fields-common" class="space-y-4">
                    <input type="text" id="location" placeholder="å ´æ‰€ãƒ»ä½æ‰€ï¼ˆåº—èˆ—ã®å ´åˆï¼‰" class="w-full p-2.5 border rounded-lg text-sm">
                    <input type="url" id="itemUrl" placeholder="ğŸ”— é€šè²©ã‚µã‚¤ãƒˆURLï¼ˆAmazon/æ¥½å¤©ãªã©ï¼‰" class="w-full p-2.5 border border-blue-200 rounded-lg text-sm bg-blue-50/30">
                    <textarea id="hours" placeholder="å–¶æ¥­æ™‚é–“ãƒ»è©³ç´°æƒ…å ±" class="w-full p-2.5 border rounded-lg h-20 text-sm"></textarea>
                </div>

                <div id="fields-hotel" class="hidden space-y-4">
                    <input type="text" id="hotel-pref" placeholder="éƒ½é“åºœçœŒ" class="w-full p-2.5 border rounded-lg text-sm">
                    <div class="grid grid-cols-2 gap-2 text-[10px] text-gray-500 font-bold">
                        <div>å†…è£…è©•ä¾¡ (1-5) <input type="number" id="hotel-interior" min="1" max="5" value="3" class="w-full p-2 border rounded"></div>
                        <div>é£Ÿäº‹è©•ä¾¡ (1-5) <input type="number" id="hotel-meal" min="1" max="5" value="3" class="w-full p-2 border rounded"></div>
                    </div>
                </div>

                <div id="fields-sushi" class="hidden space-y-4">
                    <div class="flex gap-2 text-sm">
                        <input type="text" id="sushi-parent" placeholder="é­šç¨®(ä¾‹:ã‚¤ã‚«)" class="w-1/2 p-2.5 border rounded-lg">
                        <input type="text" id="sushi-sub" placeholder="å“ç¨®(ä¾‹:ã‚¢ã‚ªãƒª)" class="w-1/2 p-2.5 border rounded-lg">
                    </div>
                </div>

                <div class="p-3 border-2 border-dashed border-emerald-100 rounded-lg">
                    <label class="text-xs font-bold text-gray-500 block mb-1">ğŸ“¸ å†™çœŸï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    <input type="file" id="photo" accept="image/*" multiple class="text-xs w-full">
                </div>

                <input type="number" id="price" placeholder="ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰" class="w-full p-2.5 border rounded-lg text-sm">
                <textarea id="memo" placeholder="ãƒ¡ãƒ¢ãƒ»ã“ã ã‚ã‚Šæˆåˆ†ãªã©" class="w-full p-2.5 border rounded-lg h-24 text-sm"></textarea>
                
                <label class="flex items-center gap-2 p-2 bg-blue-50 rounded-lg cursor-pointer">
                    <input type="checkbox" id="isPublic" class="w-4 h-4">
                    <span class="text-xs font-bold text-blue-700">è·å ´ã®ä»²é–“ã«å…¬é–‹ã™ã‚‹</span>
                </label>

                <button onclick="saveData()" id="save-btn" class="w-full bg-emerald-500 text-white py-3.5 rounded-xl font-bold shadow-md active:scale-95 transition-all">ä¿å­˜ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</button>
            </div>
        </div>

        <div id="list-container" class="space-y-6 pb-24"></div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDONjnOEGSzrN3rx-Hhlcq5ew67FTPzvbI",
            authDomain: "mutenka-app.firebaseapp.com",
            databaseURL: "https://mutenka-app-default-rtdb.firebaseio.com",
            projectId: "mutenka-app",
            storageBucket: "mutenka-app.firebasestorage.app",
            messagingSenderId: "69649285337",
            appId: "1:69649285337:web:47d607b94f3331eeca3ec8",
            measurementId: "G-E27WFBYTPL"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        let currentTab = 'gourmet';
        let viewMode = 'my';
        let editingId = null;

        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('body').classList.toggle('share-mode-bg', mode === 'share');
            document.getElementById('input-section').classList.toggle('hidden', mode === 'share');
            document.getElementById('main-title').innerText = mode === 'share' ? "âœ¨ ãŠã™ã™ã‚ã‚·ã‚§ã‚¢åç°¿" : "å®¶æ—ã®ç„¡æ·»åŠ ãƒ©ã‚¤ãƒ•ç®¡ç†";
            displayData();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-tab'));
            document.getElementById(`tab-${tab}`).classList.add('active-tab');
            document.getElementById('fields-common').classList.toggle('hidden', tab === 'hotel' || tab === 'sushi');
            document.getElementById('fields-hotel').classList.toggle('hidden', tab !== 'hotel');
            document.getElementById('fields-sushi').classList.toggle('hidden', tab !== 'sushi');
            displayData();
        }

        async function saveData() {
            const saveBtn = document.getElementById('save-btn');
            const name = document.getElementById('name').value.trim();
            if (!name) return alert('åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

            saveBtn.disabled = true;
            saveBtn.innerText = "åŒæœŸä¸­...";

            const photoFiles = document.getElementById('photo').files;
            let imageUrls = [];

            try {
                for (let file of photoFiles) {
                    const storageRef = storage.ref(`images/${Date.now()}_${file.name}`);
                    await storageRef.put(file);
                    const url = await storageRef.getDownloadURL();
                    imageUrls.push(url);
                }

                const itemData = {
                    author: document.getElementById('author').value,
                    name: name,
                    location: document.getElementById('location').value.trim(),
                    itemUrl: document.getElementById('itemUrl').value.trim(),
                    hours: document.getElementById('hours').value.trim(),
                    price: document.getElementById('price').value,
                    memo: document.getElementById('memo').value.trim(),
                    isPublic: document.getElementById('isPublic').checked,
                    category: currentTab,
                    timestamp: Date.now(),
                    prefecture: document.getElementById('hotel-pref').value,
                    interiorRating: document.getElementById('hotel-interior').value,
                    mealRating: document.getElementById('hotel-meal').value,
                    parentFish: document.getElementById('sushi-parent').value,
                    speciesFish: document.getElementById('sushi-sub').value
                };
                
                if (imageUrls.length > 0) itemData.imageUrls = imageUrls;
                if (imageUrls.length === 1) itemData.imageUrl = imageUrls[0];

                if (editingId) {
                    await database.ref('items/' + editingId).update(itemData);
                } else {
                    await database.ref('items').push(itemData);
                }
                resetForm();
            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = "ä¿å­˜ã™ã‚‹";
            }
        }

        function resetForm() {
            ['name', 'location', 'itemUrl', 'hours', 'price', 'memo', 'photo', 'hotel-pref', 'hotel-interior', 'hotel-meal', 'sushi-parent', 'sushi-sub'].forEach(id => {
                const el = document.getElementById(id); if(el) el.value = '';
            });
            document.getElementById('isPublic').checked = false;
            editingId = null;
            displayData();
        }

        function displayData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            database.ref('items').on('value', (snapshot) => {
                const container = document.getElementById('list-container');
                const data = snapshot.val();
                container.innerHTML = '';
                if (!data) return;

                Object.keys(data).reverse().forEach(key => {
                    const item = data[key];
                    if (item.category !== currentTab) return;
                    if (viewMode === 'share' && !item.isPublic) return;
                    if (searchTerm && !item.name.toLowerCase().includes(searchTerm) && !item.location?.toLowerCase().includes(searchTerm)) return;

                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name + ' ' + item.location)}`;

                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden force-left mb-6 relative';
                    
                    let imageHtml = '';
                    if (item.imageUrls) {
                        imageHtml = `<div class="flex overflow-x-auto snap-x no-scrollbar">${item.imageUrls.map(url => `<img src="${url}" class="w-full h-56 object-cover snap-center flex-shrink-0">`).join('')}</div>`;
                    } else if (item.imageUrl) {
                        imageHtml = `<img src="${item.imageUrl}" class="w-full h-56 object-cover">`;
                    }

                    div.innerHTML = `
                        ${imageHtml}
                        <div class="p-5">
                            <div class="flex justify-between items-center mb-3">
                                <span class="px-2 py-1 rounded bg-emerald-100 text-emerald-700 text-[10px] font-bold">ğŸ‘¤ ${item.author}</span>
                                ${viewMode === 'my' ? `
                                <div class="space-x-4 text-sm font-medium">
                                    <button onclick="editItem('${key}')" class="text-blue-500">ç·¨é›†</button>
                                    <button onclick="deleteItem('${key}')" class="text-red-400 font-bold">å‰Šé™¤</button>
                                </div>` : ''}
                            </div>
                            <h3 class="font-bold text-lg text-gray-900 leading-tight">
                                ${item.category === 'sushi' ? `${item.speciesFish} (${item.parentFish})` : item.name}
                            </h3>
                            
                            <div class="flex gap-4 mt-2 mb-3">
                                ${item.location ? `<a href="${mapUrl}" target="_blank" class="text-blue-600 text-xs font-bold underline">ğŸ“ åœ°å›³ã‚’è¦‹ã‚‹</a>` : ''}
                                ${item.itemUrl ? `<a href="${item.itemUrl}" target="_blank" class="text-orange-600 text-xs font-bold underline">ğŸ›’ é€šè²©ã‚µã‚¤ãƒˆã¸</a>` : ''}
                            </div>
                            
                            ${item.category === 'hotel' ? `<p class="text-[10px] text-gray-500 font-bold mb-2">ğŸ¢ ${item.prefecture} | å†…è£…:${item.interiorRating} é£Ÿäº‹:${item.mealRating}</p>` : ''}
                            
                            ${item.hours ? `
                                <details class="my-4 bg-blue-50/50 rounded-xl border border-blue-100 overflow-hidden">
                                    <summary class="p-3 text-[11px] font-bold text-blue-600 flex justify-between items-center">ğŸ•’ å–¶æ¥­æ™‚é–“ãƒ»è©³ç´°æƒ…å ± <span>â–¼</span></summary>
                                    <div class="px-3 pb-3 text-xs text-gray-700 whitespace-pre-wrap leading-relaxed border-t border-blue-100 pt-2 font-bold">${item.hours}</div>
                                </details>
                            ` : ''}
                            
                            <div class="bg-emerald-50/40 p-4 rounded-xl border-l-4 border-emerald-400 text-sm text-gray-700 whitespace-pre-wrap mt-2">${item.memo}</div>
                            ${item.price ? `<p class="text-right text-[10px] text-gray-400 mt-2 font-bold">å‚è€ƒä¾¡æ ¼: Â¥${Number(item.price).toLocaleString()}</p>` : ''}
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function editItem(key) {
            database.ref('items/' + key).once('value').then((snapshot) => {
                const item = snapshot.val();
                document.getElementById('author').value = item.author;
                document.getElementById('name').value = item.name;
                document.getElementById('location').value = item.location || '';
                document.getElementById('itemUrl').value = item.itemUrl || '';
                document.getElementById('hours').value = item.hours || '';
                document.getElementById('price').value = item.price || '';
                document.getElementById('memo').value = item.memo;
                document.getElementById('isPublic').checked = item.isPublic || false;
                document.getElementById('hotel-pref').value = item.prefecture || '';
                document.getElementById('hotel-interior').value = item.interiorRating || '';
                document.getElementById('hotel-meal').value = item.mealRating || '';
                document.getElementById('sushi-parent').value = item.parentFish || '';
                document.getElementById('sushi-sub').value = item.speciesFish || '';
                
                editingId = key;
                document.getElementById('save-btn').innerText = 'å¤‰æ›´ã‚’ä¿å­˜';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        function deleteItem(key) {
            if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) database.ref('items/' + key).remove();
        }

        displayData();
    </script>
</body>
</html>