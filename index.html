<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã“ã ã‚ã‚Šã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        .active-tab { border-bottom: 4px solid #10b981; color: #10b981; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .share-mode-bg { background-color: #f0fdf4 !important; }
        #qr-modal { display: none; }
    </style>
</head>
<body id="body" class="bg-gray-100 text-gray-900 font-sans pb-10 transition-colors duration-300">

    <header class="bg-emerald-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <h1 class="text-xl font-bold text-center">ã“ã ã‚ã‚Šã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯</h1>
        <div id="mode-switcher" class="flex justify-center mt-3 hidden">
            <div class="inline-flex bg-emerald-700/50 rounded-lg p-1 gap-1">
                <button onclick="setViewMode('my')" id="mode-my" class="px-4 py-1 rounded-md text-[10px] font-bold bg-white text-emerald-700 shadow-sm">è‡ªåˆ†ãƒ»å®¶æ—ç”¨</button>
                <button onclick="setViewMode('share')" id="mode-share" class="px-4 py-1 rounded-md text-[10px] font-bold text-white/70">è·å ´å…±æœ‰ç”¨</button>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto">
        <div id="section-home" class="grid grid-cols-1 gap-6 pt-10">
            <button onclick="startCameraMode()" class="flex flex-col items-center justify-center p-6 bg-blue-600 text-white rounded-3xl shadow-lg active:scale-95 transition-all">
                <span class="text-4xl mb-2">ğŸ“¸</span>
                <span class="font-bold text-lg">ã‚«ãƒ¡ãƒ©ã§ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ›</span>
            </button>
            <button onclick="startManualMode()" class="flex flex-col items-center justify-center p-6 bg-white text-emerald-700 border-2 border-emerald-100 rounded-3xl shadow-lg active:scale-95 transition-all">
                <span class="text-4xl mb-2">ğŸ“</span>
                <span class="font-bold text-lg">ã˜ã£ãã‚Šè©³ç´°å…¥åŠ›</span>
            </button>
            <button onclick="startBrowseMode()" class="flex flex-col items-center justify-center p-6 bg-emerald-500 text-white rounded-3xl shadow-lg active:scale-95 transition-all">
                <span class="text-4xl mb-2">ğŸ‘€</span>
                <span class="font-bold text-lg">ã¿ã‚“ãªã®è¨˜éŒ²ã‚’è¦‹ã‚‹</span>
            </button>
        </div>

        <div id="qr-modal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-6">
            <div class="bg-white p-8 rounded-3xl text-center w-full max-w-xs">
                <h3 class="font-bold text-emerald-700 mb-4">è·å ´å…±æœ‰ç”¨QR</h3>
                <div id="qr-code-area" class="bg-gray-100 aspect-square w-full mb-4 flex items-center justify-center overflow-hidden rounded-xl">
                    </div>
                <p class="text-[10px] text-gray-500 mb-6 font-bold">ç›¸æ‰‹ã«ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚‚ã‚‰ã†ã¨<br>ã€Œå…±æœ‰ç”¨ãƒªã‚¹ãƒˆã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                <button onclick="closeQR()" class="w-full py-3 bg-gray-200 text-gray-600 rounded-xl font-bold">é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <div id="section-browse" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <button onclick="goHome()" class="text-emerald-700 font-bold text-sm">â† æˆ»ã‚‹</button>
                <div class="flex gap-2 w-2/3">
                    <input type="text" id="searchInput" oninput="displayData()" placeholder="ğŸ” æ¤œç´¢..." class="p-2 border rounded-full text-xs w-full outline-none bg-white">
                    <button onclick="showQR()" id="btn-show-qr" class="bg-white border border-emerald-200 p-2 rounded-full shadow-sm text-lg">ğŸ“²</button>
                </div>
            </div>
            <nav class="flex overflow-x-auto gap-2 mb-6 no-scrollbar border-b pb-2">
                <button onclick="switchTab('gourmet')" id="tab-gourmet" class="px-3 py-1 whitespace-nowrap active-tab font-bold text-sm">ã‚°ãƒ«ãƒ¡</button>
                <button onclick="switchTab('item')" id="tab-item" class="px-3 py-1 whitespace-nowrap font-bold text-sm text-gray-400">èª¿å‘³æ–™ãƒ»æ—¥ç”¨å“</button>
                <button onclick="switchTab('hotel')" id="tab-hotel" class="px-3 py-1 whitespace-nowrap font-bold text-sm text-gray-400">ãƒ›ãƒ†ãƒ«</button>
                <button onclick="switchTab('sushi')" id="tab-sushi" class="px-3 py-1 whitespace-nowrap font-bold text-sm text-gray-400">å¯¿å¸</button>
            </nav>
            <div id="list-container" class="space-y-6 pb-20"></div>
        </div>

        <div id="section-form" class="hidden bg-white p-6 rounded-3xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-emerald-700">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                <button onclick="goHome()" class="text-gray-400 font-bold">Ã— é–‰ã˜ã‚‹</button>
            </div>
            <div class="space-y-4 text-left">
                <select id="author" class="w-full p-2.5 border rounded-xl bg-gray-50 text-sm font-bold">
                    <option value="ã—ã‚‡ã†ã‚„">ğŸ‘¤ ã—ã‚‡ã†ã‚„</option>
                    <option value="ã˜ã‚…ã‚“ã“">ğŸ‘© ã˜ã‚…ã‚“ã“</option>
                    <option value="ãµã¿ã²ã“">ğŸ‘¨ ãµã¿ã²ã“</option>
                </select>
                <select id="input-category" onchange="toggleCategoryFields(this.value)" class="w-full p-2.5 border-2 border-blue-100 rounded-xl bg-blue-50 text-xs font-bold text-blue-700">
                    <option value="gourmet">ğŸ´ ã‚°ãƒ«ãƒ¡</option>
                    <option value="item">ğŸ§´ èª¿å‘³æ–™ãƒ»æ—¥ç”¨å“</option>
                    <option value="hotel">ğŸ¨ ãƒ›ãƒ†ãƒ«</option>
                    <option value="sushi">ğŸ£ å¯¿å¸</option>
                </select>
                <input type="text" id="name" placeholder="åç§°" class="w-full p-3 border rounded-xl font-bold">
                <div id="fields-hotel" class="hidden space-y-3 bg-gray-50 p-3 rounded-xl">
                    <input type="text" id="hotel-pref" placeholder="éƒ½é“åºœçœŒ" class="w-full p-2 border rounded text-sm">
                </div>
                <label class="flex items-center gap-3 p-3 bg-emerald-50 rounded-xl cursor-pointer border border-emerald-100">
                    <input type="checkbox" id="isPublic" class="w-5 h-5 accent-emerald-600">
                    <span class="text-sm font-bold text-emerald-700 font-bold">è·å ´ã®ä»²é–“ã«å…¬é–‹ã™ã‚‹</span>
                </label>
                <textarea id="memo" placeholder="ã“ã ã‚ã‚Šãƒ¡ãƒ¢" class="w-full p-3 border rounded-xl h-24 text-sm"></textarea>
                <button onclick="saveData()" id="save-btn" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-lg">ä¿å­˜ã—ã¦åŒæœŸ</button>
            </div>
        </div>

        <div id="section-camera" class="hidden">
            <div id="reader" class="mb-4 shadow-2xl overflow-hidden rounded-3xl"></div>
            <button onclick="goHome()" class="w-full py-3 bg-gray-400 text-white rounded-xl font-bold">Ã— æˆ»ã‚‹</button>
        </div>
    </main>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDONjnOEGSzrN3rx-Hhlcq5ew67FTPzvbI",
            authDomain: "mutenka-app.firebaseapp.com",
            databaseURL: "https://mutenka-app-default-rtdb.firebaseio.com",
            projectId: "mutenka-app",
            storageBucket: "mutenka-app.firebasestorage.app",
            messagingSenderId: "69649285337",
            appId: "1:69649285337:web:47d607b94f3331eeca3ec8"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentTab = 'gourmet', viewMode = 'my';

        // èµ·å‹•æ™‚ã«URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªï¼ˆå…±æœ‰ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã‹ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯ï¼‰
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('view') === 'share') {
                startBrowseMode();
                setViewMode('share');
                // å…±æœ‰ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã¨æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
                document.getElementById('mode-switcher').style.display = 'none';
                document.querySelector('#section-browse button').style.display = 'none';
                document.getElementById('btn-show-qr').style.display = 'none';
            }
        };

        function showQR() {
            const shareUrl = `${window.location.origin}${window.location.pathname}?view=share`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareUrl)}`;
            document.getElementById('qr-code-area').innerHTML = `<img src="${qrUrl}" class="w-full shadow-inner">`;
            document.getElementById('qr-modal').style.display = 'flex';
        }
        function closeQR() { document.getElementById('qr-modal').style.display = 'none'; }

        // --- ä»¥ä¸‹ã€æ—¢å­˜ã®åŸºæœ¬æ©Ÿèƒ½ã‚’çµ±åˆ ---
        function goHome() {
            ['section-home', 'section-form', 'section-browse', 'section-camera', 'mode-switcher'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('section-home').classList.remove('hidden');
        }
        function startBrowseMode() {
            document.getElementById('section-home').classList.add('hidden');
            document.getElementById('section-browse').classList.remove('hidden');
            document.getElementById('mode-switcher').classList.remove('hidden');
            displayData();
        }
        function startManualMode() {
            document.getElementById('section-home').classList.add('hidden');
            document.getElementById('section-form').classList.remove('hidden');
        }
        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('body').classList.toggle('share-mode-bg', mode === 'share');
            displayData();
        }
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('nav button').forEach(btn => btn.className = 'px-3 py-1 whitespace-nowrap font-bold text-sm text-gray-400');
            document.getElementById(`tab-${tab}`).className = 'px-3 py-1 whitespace-nowrap active-tab font-bold text-sm';
            displayData();
        }
        function displayData() {
            database.ref('items').on('value', (snapshot) => {
                const container = document.getElementById('list-container');
                container.innerHTML = '';
                const data = snapshot.val();
                if (!data) return;
                Object.keys(data).reverse().forEach(key => {
                    const item = data[key];
                    if (item.category !== currentTab) return;
                    if (viewMode === 'share' && !item.isPublic) return;
                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-3xl shadow-sm border p-5 text-left mb-6';
                    div.innerHTML = `
                        <div class="flex justify-between text-[9px] font-bold text-emerald-600 mb-2">ğŸ‘¤ ${item.author}</div>
                        <h3 class="font-bold text-lg">${item.name}</h3>
                        <div class="bg-emerald-50/50 p-4 rounded-xl text-xs mt-3 whitespace-pre-wrap">${item.memo}</div>
                    `;
                    container.appendChild(div);
                });
            });
        }
        // (çœç•¥: saveData, startCameraMode ãªã©ã®å®Ÿè£…ã¯å‰å›ã¨åŒæ§˜ã«ä¿æŒã—ã¦ãã ã•ã„)
    </script>
</body>
</html>