<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã“ã ã‚ã‚Šã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯ - ç©¶æ¥µçµ±åˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        .active-tab { border-bottom: 4px solid #10b981; color: #10b981; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #reader { width: 100%; border-radius: 20px; overflow: hidden; display: none; margin-bottom: 20px; }
    </style>
</head>
<body id="body" class="bg-gray-100 text-gray-900 font-sans pb-20">

    <header class="bg-emerald-600 text-white p-4 shadow-lg sticky top-0 z-40">
        <h1 class="text-xl font-bold text-center">ã“ã ã‚ã‚Šã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯</h1>
        <div class="flex justify-center mt-3">
            <div class="inline-flex bg-emerald-700/50 rounded-lg p-1">
                <button onclick="setViewMode('my')" id="mode-my" class="px-4 py-1 rounded-md text-[10px] font-bold bg-white text-emerald-700 shadow-sm">è‡ªåˆ†ãƒ»å®¶æ—ç”¨</button>
                <button onclick="setViewMode('share')" id="mode-share" class="px-4 py-1 rounded-md text-[10px] font-bold text-white/70">è·å ´å…±æœ‰ç”¨</button>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto">
        <div id="start-menu" class="grid grid-cols-1 gap-4 mb-8">
            <button onclick="startSmartInput()" class="bg-blue-600 text-white p-8 rounded-3xl shadow-xl active:scale-95 transition-all text-center">
                <div class="text-3xl mb-2">ğŸ“¸</div>
                <div class="font-bold text-lg">ã‚«ãƒ¡ãƒ©ã§ã¨ã‚Šã‚ãˆãšæƒ…å ±å…¥åŠ›</div>
                <div class="text-[10px] opacity-80">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šãƒ»è‡ªå‹•åå¯„ã›</div>
            </button>
            <button onclick="showForm()" class="bg-white text-emerald-700 p-8 rounded-3xl shadow-md active:scale-95 transition-all text-center border-2 border-emerald-100">
                <div class="text-3xl mb-2">ğŸ“</div>
                <div class="font-bold text-lg">ç¾åœ¨ã®å…¥åŠ›ãƒšãƒ¼ã‚¸</div>
                <div class="text-[10px] text-gray-400">ã˜ã£ãã‚Šè©³ã—ãå…¥åŠ›ã™ã‚‹</div>
            </button>
        </div>

        <div id="reader" class="shadow-2xl"></div>

        <div id="input-section" class="hidden bg-white p-5 rounded-3xl shadow-sm mb-8 border border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h2 id="form-type-label" class="text-lg font-bold text-emerald-700 font-bold">ğŸ“ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
                <button onclick="hideForm()" class="text-gray-400 text-xs font-bold">Ã— æˆ»ã‚‹</button>
            </div>
            
            <div class="space-y-4">
                <select id="author" class="w-full p-2.5 border rounded-xl bg-emerald-50 font-bold text-sm">
                    <option value="ã—ã‚‡ã†ã‚„">ğŸ‘¤ ã—ã‚‡ã†ã‚„</option>
                    <option value="ã˜ã‚…ã‚“ã“">ğŸ‘© ã˜ã‚…ã‚“ã“</option>
                    <option value="ãµã¿ã²ã“">ğŸ‘¨ ãµã¿ã²ã“</option>
                </select>

                <input type="text" id="name" placeholder="åç§°ï¼ˆåº—åãƒ»å•†å“åï¼‰" class="w-full p-2.5 border rounded-xl text-sm font-bold">
                <input type="hidden" id="barcode-val">

                <div id="fields-common" class="space-y-4">
                    <input type="text" id="location" placeholder="å ´æ‰€ãƒ»ä½æ‰€" class="w-full p-2.5 border rounded-xl text-sm">
                    <div class="flex gap-2">
                        <input type="url" id="itemUrl" placeholder="ğŸ”— é€šè²©URL" class="w-full p-2.5 border border-blue-100 rounded-xl text-sm bg-blue-50/30">
                    </div>
                    <textarea id="hours" placeholder="å–¶æ¥­æ™‚é–“ãƒ»è©³ç´°" class="w-full p-2.5 border rounded-xl h-20 text-sm"></textarea>
                </div>

                <div class="p-3 border-2 border-dashed border-emerald-100 rounded-xl bg-gray-50/50">
                    <label class="text-[10px] font-bold text-gray-500 block mb-2">ğŸ“¸ å†™çœŸï¼ˆæˆåˆ†è¡¨ã‹ã‚‰AIè§£æï¼‰</label>
                    <input type="file" id="photo" accept="image/*" multiple class="text-[10px] w-full mb-2" onchange="processOCR(this)">
                    <div id="ocr-status" class="text-[9px] text-blue-600 font-bold"></div>
                </div>

                <textarea id="memo" placeholder="ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ" class="w-full p-2.5 border rounded-xl h-24 text-sm"></textarea>
                
                <button onclick="saveData()" id="save-btn" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-lg">ä¿å­˜ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</button>
            </div>
        </div>

        <nav id="category-nav" class="flex overflow-x-auto gap-2 mb-4 no-scrollbar">
            <button onclick="switchTab('gourmet')" id="tab-gourmet" class="px-4 py-2 whitespace-nowrap active-tab font-bold text-sm">ã‚°ãƒ«ãƒ¡</button>
            <button onclick="switchTab('item')" id="tab-item" class="px-4 py-2 whitespace-nowrap font-bold text-sm text-gray-400">èª¿å‘³æ–™ãƒ»æ—¥ç”¨å“</button>
            <button onclick="switchTab('hotel')" id="tab-hotel" class="px-4 py-2 whitespace-nowrap font-bold text-sm text-gray-400">ãƒ›ãƒ†ãƒ«</button>
            <button onclick="switchTab('sushi')" id="tab-sushi" class="px-4 py-2 whitespace-nowrap font-bold text-sm text-gray-400">å¯¿å¸</button>
        </nav>

        <div id="list-container" class="space-y-6"></div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDONjnOEGSzrN3rx-Hhlcq5ew67FTPzvbI",
            authDomain: "mutenka-app.firebaseapp.com",
            databaseURL: "https://mutenka-app-default-rtdb.firebaseio.com",
            projectId: "mutenka-app",
            storageBucket: "mutenka-app.firebasestorage.app",
            messagingSenderId: "69649285337",
            appId: "1:69649285337:web:47d607b94f3331eeca3ec8"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database(), storage = firebase.storage();
        let currentTab = 'gourmet', viewMode = 'my', editingId = null;

        function showForm() { document.getElementById('start-menu').classList.add('hidden'); document.getElementById('input-section').classList.remove('hidden'); }
        function hideForm() { document.getElementById('start-menu').classList.remove('hidden'); document.getElementById('input-section').classList.add('hidden'); resetForm(); }

        function startSmartInput() {
            const readerEl = document.getElementById('reader');
            readerEl.style.display = 'block';
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                html5QrCode.stop();
                readerEl.style.display = 'none';
                checkExistingProduct(decodedText);
            });
        }

        async function checkExistingProduct(barcode) {
            const snapshot = await database.ref('items').orderByChild('barcode').equalTo(barcode).once('value');
            const data = snapshot.val();
            showForm();
            document.getElementById('barcode-val').value = barcode;
            if (data) {
                editingId = Object.keys(data)[0];
                const item = data[editingId];
                document.getElementById('name').value = item.name;
                document.getElementById('memo').value = item.memo;
                document.getElementById('save-btn').innerText = "ä¸Šæ›¸ãä¿å­˜ã™ã‚‹";
                alert("åŒã˜ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¸Šæ›¸ãæ›´æ–°ã—ã¾ã™ã€‚");
            } else {
                document.getElementById('name').value = "JAN:" + barcode;
                document.getElementById('save-btn').innerText = "æ–°è¦ä¿å­˜ã™ã‚‹";
            }
        }

        async function processOCR(input) {
            if (!input.files[0]) return;
            const status = document.getElementById('ocr-status');
            status.innerText = "â³ AIè§£æä¸­...";
            const result = await Tesseract.recognize(input.files[0], 'jpn');
            document.getElementById('memo').value += "\nã€AIè§£æã€‘" + result.data.text;
            status.innerText = "âœ… è§£æå®Œäº†";
        }

        async function saveData() {
            const saveBtn = document.getElementById('save-btn');
            const name = document.getElementById('name').value;
            if (!name) return alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            saveBtn.disabled = true;
            saveBtn.innerText = "ä¿å­˜ä¸­...";

            const photoFiles = document.getElementById('photo').files;
            let imageUrls = [];
            for (let file of photoFiles) {
                const storageRef = storage.ref(`images/${Date.now()}_${file.name}`);
                await storageRef.put(file);
                imageUrls.push(await storageRef.getDownloadURL());
            }

            const itemData = {
                author: document.getElementById('author').value,
                name: name,
                barcode: document.getElementById('barcode-val').value || "",
                location: document.getElementById('location').value,
                itemUrl: document.getElementById('itemUrl').value,
                hours: document.getElementById('hours').value,
                memo: document.getElementById('memo').value,
                category: currentTab,
                timestamp: Date.now(),
                imageUrls: imageUrls
            };

            const ref = editingId ? database.ref('items/' + editingId) : database.ref('items').push();
            await ref.set(itemData);
            hideForm();
        }

        function resetForm() {
            ['name', 'location', 'itemUrl', 'memo', 'photo', 'barcode-val'].forEach(id => {
                const el = document.getElementById(id); if(el) el.value = '';
            });
            editingId = null;
            document.getElementById('save-btn').innerText = "ä¿å­˜ã—ã¦åŒæœŸ";
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-tab', 'text-gray-900'));
            document.querySelectorAll('nav button').forEach(btn => btn.classList.add('text-gray-400'));
            document.getElementById(`tab-${tab}`).classList.add('active-tab');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-400');
            displayData();
        }

        function displayData() {
            database.ref('items').on('value', (snapshot) => {
                const container = document.getElementById('list-container');
                container.innerHTML = '';
                const data = snapshot.val();
                if (!data) return;
                Object.keys(data).reverse().forEach(key => {
                    const item = data[key];
                    if (item.category !== currentTab) return;
                    const div = document.createElement('div');
                    div.className = 'bg-white p-5 rounded-3xl shadow-sm border mb-4 text-left';
                    div.innerHTML = `
                        ${item.imageUrls ? `<img src="${item.imageUrls[0]}" class="w-full h-40 object-cover rounded-2xl mb-3">` : ''}
                        <div class="flex justify-between text-[9px] text-emerald-600 font-bold mb-1">
                            <span>ğŸ‘¤ ${item.author}</span>
                            <span>${new Date(item.timestamp).toLocaleDateString()}</span>
                        </div>
                        <h3 class="font-bold text-lg">${item.name}</h3>
                        <p class="text-xs text-gray-500 mt-2 whitespace-pre-wrap">${item.memo}</p>
                    `;
                    container.appendChild(div);
                });
            });
        }
        displayData();
    </script>
</body>
</html>