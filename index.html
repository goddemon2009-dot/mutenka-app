<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.4/dist/tesseract.min.js"></script>
    
    <style type="text/tailwindcss">
        .active-tab { border-bottom: 4px solid #10b981; @apply text-emerald-600; }
        .menu-btn { @apply flex flex-col items-center p-6 rounded-3xl transition-all active:scale-95 shadow-md; }
        .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        #reader { width: 100%; border-radius: 24px; overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
    <header class="bg-emerald-600 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-xl font-bold">ã“ã ã‚ã‚Šã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯</h1>
        <div id="auth-ui">
            <button id="login-btn" onclick="login()" class="text-xs bg-white/20 px-3 py-1 rounded-lg border border-white/50">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button id="logout-btn" onclick="logout()" class="hidden text-xs bg-red-500/80 px-3 py-1 rounded-lg">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto">
        <div id="section-home" class="grid grid-cols-1 gap-6 pt-10 text-center">
            <button onclick="startCameraMode()" class="menu-btn bg-blue-600 text-white"><span class="text-4xl mb-2">ğŸ“¸</span><span class="font-bold text-lg">ã‚«ãƒ¡ãƒ©ã§ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ›</span></button>
            <button onclick="showSection('section-form')" class="menu-btn bg-white text-emerald-700 border-2 border-emerald-100"><span class="text-4xl mb-2">ğŸ“</span><span class="font-bold text-lg">è©³ç´°å…¥åŠ›ãƒ»æ€ã„å‡ºã‚’è¨˜éŒ²</span></button>
            <button onclick="showSection('section-browse'); displayData();" class="menu-btn bg-emerald-500 text-white"><span class="text-4xl mb-2">ğŸ‘€</span><span class="font-bold text-lg">ã¿ã‚“ãªã®è¨˜éŒ²ã‚’è¦‹ã‚‹</span></button>
        </div>

        <div id="section-camera" class="hidden">
            <div id="reader" class="shadow-2xl mb-4 bg-black"></div>
            <button onclick="showSection('section-home')" class="w-full py-3 bg-gray-400 text-white rounded-xl font-bold">Ã— æˆ»ã‚‹</button>
        </div>

        <div id="section-form" class="hidden bg-white p-6 rounded-3xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-emerald-700">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                <button onclick="showSection('section-home'); resetForm();" class="text-gray-400 font-bold text-xl">Ã—</button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-2">
                    <select id="author" class="p-2.5 border rounded-xl bg-gray-50 text-sm font-bold">
                        <option value="ã—ã‚‡ã†ã‚„">ğŸ‘¤ ã—ã‚‡ã†ã‚„</option><option value="ã˜ã‚…ã‚“ã“">ğŸ‘© ã˜ã‚…ã‚“ã“</option><option value="ãµã¿ã²ã“">ğŸ‘¨ ãµã¿ã²ã“</option>
                    </select>
                    <select id="category" onchange="toggleFields(this.value)" class="p-2.5 border-2 border-blue-100 rounded-xl bg-blue-50 text-xs font-bold text-blue-700">
                        <option value="gourmet">ğŸ´ ã‚°ãƒ«ãƒ¡</option><option value="item">ğŸ§´ èª¿å‘³æ–™ãƒ»æ—¥ç”¨å“</option><option value="hotel">ğŸ¨ ãƒ›ãƒ†ãƒ«</option><option value="sushi">ğŸ£ å¯¿å¸</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="name" placeholder="åç§°" class="w-full p-3 border rounded-xl font-bold">
                    <button id="btn-addr" onclick="magicSearch('name')" class="bg-blue-500 text-white px-3 rounded-xl text-[10px] font-bold whitespace-nowrap">ğŸ” ä½æ‰€æ¤œç´¢</button>
                </div>

                <div id="div-phone" class="flex gap-2">
                    <input type="tel" id="phone" placeholder="é›»è©±ç•ªå·" class="w-full p-3 border rounded-xl text-sm">
                    <button onclick="magicSearch('phone')" class="bg-indigo-500 text-white px-3 rounded-xl text-[10px] font-bold whitespace-nowrap">ğŸ“ æ¤œç´¢</button>
                </div>

                <div id="div-sushi" class="hidden space-y-2 bg-red-50 p-3 rounded-xl"><input type="text" id="sushiFish" placeholder="ãƒã‚¿" class="w-full p-2 text-xs border rounded-lg"><input type="text" id="sushiVinegar" placeholder="ã‚·ãƒ£ãƒªãƒ»å‘³ä»˜ã‘" class="w-full p-2 text-xs border rounded-lg"></div>
                <div id="div-hotel" class="hidden space-y-2 bg-indigo-50 p-3 rounded-xl"><input type="text" id="hotelInterior" placeholder="å†…è£…" class="w-full p-2 text-xs border rounded-lg"><input type="text" id="hotelMeal" placeholder="é£Ÿäº‹" class="w-full p-2 text-xs border rounded-lg"></div>
                <div id="div-item" class="hidden space-y-3"><div id="price-list" class="space-y-3"></div><button onclick="addPriceField()" class="w-full py-2 bg-orange-50 text-orange-600 border border-orange-200 rounded-xl text-xs font-bold">+ è³¼å…¥å…ˆã‚’è¿½åŠ </button></div>

                <input type="text" id="location" placeholder="ä½æ‰€ãƒ»å ´æ‰€" class="w-full p-3 border rounded-xl text-sm">
                <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100"><label class="text-[10px] font-bold text-yellow-600">æº€è¶³åº¦</label><input type="range" id="rating" min="1" max="5" value="3" class="w-full accent-yellow-500"></div>
                <input type="url" id="url" placeholder="ğŸ”— URL" class="w-full p-3 border border-blue-100 rounded-xl text-sm bg-blue-50/20">
                
                <div class="p-4 border-2 border-dashed border-emerald-100 rounded-xl bg-emerald-50/20">
                    <input type="file" id="photo" accept="image/*" multiple class="text-xs w-full" onchange="processOCR(this)">
                    <div id="ocr-status" class="text-[9px] text-blue-600 font-bold mt-2"></div>
                </div>

                <textarea id="memo" placeholder="ã“ã ã‚ã‚Šãƒ¡ãƒ¢" class="w-full p-3 border rounded-xl h-24 text-sm"></textarea>
                <input type="hidden" id="barcode">
                
                <button onclick="saveData()" id="save-btn" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-lg disabled:bg-gray-300">ä¿å­˜ã—ã¦åŒæœŸ</button>
            </div>
        </div>

        <div id="section-browse" class="hidden">
            <div class="flex justify-between items-center mb-4 sticky top-16 bg-gray-100 py-2 z-40">
                <button onclick="showSection('section-home')" class="text-emerald-700 font-bold text-sm">â† æˆ»ã‚‹</button>
                <input type="text" id="search" oninput="displayData()" placeholder="ğŸ” æ¤œç´¢..." class="p-2 border rounded-full text-xs w-1/2 shadow-sm outline-none">
            </div>
            <nav class="flex overflow-x-auto gap-4 mb-6 no-scrollbar border-b pb-2 font-bold sticky top-28 bg-gray-100 z-40">
                <button onclick="switchTab('gourmet')" id="tab-gourmet" class="active-tab">ã‚°ãƒ«ãƒ¡</button>
                <button onclick="switchTab('item')" id="tab-item" class="text-gray-400">æ—¥ç”¨å“</button>
                <button onclick="switchTab('hotel')" id="tab-hotel" class="text-gray-400">ãƒ›ãƒ†ãƒ«</button>
                <button onclick="switchTab('sushi')" id="tab-sushi" class="text-gray-400">å¯¿å¸</button>
            </nav>
            <div id="list-container" class="space-y-6 pb-20"></div>
        </div>
    </main>

    <script>
        // è¨­å®š
        const firebaseConfig = { apiKey: "AIzaSyDONjnOEGSzrN3rx-Hhlcq5ew67FTPzvbI", authDomain: "mutenka-app.firebaseapp.com", databaseURL: "https://mutenka-app-default-rtdb.firebaseio.com", projectId: "mutenka-app", storageBucket: "mutenka-app.firebasestorage.app", messagingSenderId: "69649285337", appId: "1:69649285337:web:47d607b94f3331eeca3ec8" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth(), storage = firebase.storage();
        let currentTab = 'gourmet', editingId = null, user = null;

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        auth.onAuthStateChanged(u => {
            user = u;
            document.getElementById('login-btn').classList.toggle('hidden', !!u);
            document.getElementById('logout-btn').classList.toggle('hidden', !u);
            document.getElementById('save-btn').disabled = !u;
            if (u) console.log("Your UID:", u.uid);
            displayData();
        });

        async function login() {
            try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } 
            catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + e.message); }
        }
        function logout() { if(confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) auth.signOut(); }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showSection(id) {
            ['section-home', 'section-camera', 'section-form', 'section-browse'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function toggleFields(cat) {
            document.getElementById('div-sushi').classList.toggle('hidden', cat !== 'sushi');
            document.getElementById('div-hotel').classList.toggle('hidden', cat !== 'hotel');
            document.getElementById('div-item').classList.toggle('hidden', cat !== 'item');
            document.getElementById('div-phone').classList.toggle('hidden', cat === 'sushi' || cat === 'item');
            document.getElementById('btn-addr').classList.toggle('hidden', cat === 'sushi' || cat === 'item');
            const n = document.getElementById('name'), l = document.getElementById('location');
            if (cat === 'sushi') { n.placeholder = "ãƒã‚¿"; l.placeholder = "åº—å"; } else { n.placeholder = "åç§°"; l.placeholder = "å ´æ‰€ãƒ»ä½æ‰€"; }
        }

        // ãƒ‡ãƒ¼ã‚¿æ“ä½œ
        async function saveData() {
            if (!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
            const name = document.getElementById('name').value.trim();
            if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "åŒæœŸä¸­...";

            try {
                let imageUrls = [];
                const files = document.getElementById('photo').files;
                for (let f of files) {
                    const ref = storage.ref(`images/${Date.now()}_${f.name}`);
                    await ref.put(f);
                    imageUrls.push(await ref.getDownloadURL());
                }

                const prices = Array.from(document.querySelectorAll('#price-list > div')).map(el => ({
                    shop: el.querySelector('.p-shop').value, price: el.querySelector('.p-val').value, url: el.querySelector('.p-url').value
                }));

                const data = {
                    author: document.getElementById('author').value, name, category: document.getElementById('category').value,
                    location: document.getElementById('location').value, phone: document.getElementById('phone').value,
                    url: document.getElementById('url').value, memo: document.getElementById('memo').value,
                    rating: document.getElementById('rating').value, sushiFish: document.getElementById('sushiFish').value,
                    sushiVinegar: document.getElementById('sushiVinegar').value, hotelInterior: document.getElementById('hotelInterior').value,
                    hotelMeal: document.getElementById('hotelMeal').value, barcode: document.getElementById('barcode').value,
                    timestamp: Date.now(), imageUrls: imageUrls.length ? imageUrls : null
                };

                const dbRef = editingId ? db.ref('items/' + editingId) : db.ref('items').push();
                await dbRef.update(data);
                resetForm(); showSection('section-browse');
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); } finally { btn.disabled = false; btn.innerText = "ä¿å­˜ã—ã¦åŒæœŸ"; }
        }

        function displayData() {
            db.ref('items').off();
            db.ref('items').on('value', snap => {
                const container = document.getElementById('list-container');
                container.innerHTML = '';
                const items = snap.val(); if (!items) return;
                const searchTxt = document.getElementById('search').value.toLowerCase();

                Object.keys(items).reverse().forEach(id => {
                    const it = items[id];
                    if (it.category !== currentTab || (searchTxt && !it.name.toLowerCase().includes(searchTxt))) return;

                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-3xl shadow-sm border p-5 font-bold';
                    div.innerHTML = `
                        ${it.imageUrls ? `<div class="image-grid mb-4">${it.imageUrls.map(u => `<img src="${u}" class="w-full h-24 object-cover rounded-xl">`).join('')}</div>` : ''}
                        <div class="flex justify-between text-[10px] mb-2">
                            <span class="text-emerald-600">ğŸ‘¤ ${it.author}</span>
                            <div class="${user ? '' : 'hidden'} space-x-3 text-gray-400">
                                <button onclick="editItem('${id}')">ç·¨é›†</button><button onclick="deleteItem('${id}')" class="text-red-300">å‰Šé™¤</button>
                            </div>
                        </div>
                        <h3 class="text-lg mb-1">${it.name}</h3>
                        <div class="text-yellow-500 mb-2">â­${"â­".repeat(it.rating - 1)}</div>
                        <p class="text-xs text-gray-500 mb-3">${it.location || ''}</p>
                        <div class="bg-emerald-50 p-3 rounded-xl text-xs text-gray-600 mb-2 whitespace-pre-wrap">${it.memo || ''}</div>
                        ${it.url ? `<a href="${it.url}" target="_blank" class="text-blue-500 text-[10px] underline">ğŸ”— ãƒªãƒ³ã‚¯ã‚’è¦‹ã‚‹</a>` : ''}
                    `;
                    container.appendChild(div);
                });
            });
        }

        function editItem(id) {
            db.ref('items/' + id).once('value', snap => {
                const it = snap.val(); editingId = id; showSection('section-form');
                document.getElementById('category').value = it.category; toggleFields(it.category);
                document.getElementById('name').value = it.name;
                document.getElementById('location').value = it.location;
                document.getElementById('memo').value = it.memo;
                document.getElementById('rating').value = it.rating;
                // ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
            });
        }

        function deleteItem(id) { if(confirm('æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) db.ref('items/' + id).remove(); }
        function resetForm() { editingId = null; document.getElementById('name').value = ''; document.getElementById('memo').value = ''; document.getElementById('price-list').innerHTML = ''; }
        function addPriceField() {
            const d = document.createElement('div'); d.className = 'p-3 bg-gray-50 rounded-xl space-y-2';
            d.innerHTML = `<input type="text" placeholder="åº—" class="p-shop w-full p-2 text-xs border rounded-lg"><div class="flex gap-2"><input type="number" placeholder="ä¾¡æ ¼" class="p-val w-24 p-2 text-xs border rounded-lg"><input type="text" placeholder="URL" class="p-url w-full p-2 text-xs border rounded-lg"></div>`;
            document.getElementById('price-list').appendChild(d);
        }
        function switchTab(t) { currentTab = t; document.querySelectorAll('nav button').forEach(b => b.className = 'text-gray-400'); document.getElementById('tab-'+t).className = 'active-tab'; displayData(); }
        async function magicSearch(t) { const q = document.getElementById(t).value; window.open(`https://www.google.com/search?q=${encodeURIComponent(q + (t==='name'?' ä½æ‰€':''))}`, '_blank'); }
        function startCameraMode() { showSection('section-camera'); const h = new Html5Qrcode("reader"); h.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (d) => { h.stop(); document.getElementById('barcode').value = d; showSection('section-form'); toggleFields('item'); }); }
        async function processOCR(i) { document.getElementById('ocr-status').innerText = "â³ è§£æä¸­..."; const r = await Tesseract.recognize(i.files[0], 'jpn'); document.getElementById('memo').value += "\n" + r.data.text; document.getElementById('ocr-status').innerText = "âœ… å®Œäº†"; }
    </script>
</body>
</html>
